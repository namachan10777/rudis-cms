{% for table in tables%}
INSERT INTO {{table.name}}({{ table.columns | map: "name" | join: ", " }})
SELECT
{%- for column in table.columns %}
    value->>'{{ column.name }}'{% unless forloop.last %},{% endunless %}
{%- endfor %}
FROM json_each(?1->>'{{ table.name }}')
WHERE 1
ON CONFLICT ({{ table.primary_key | join: ", " }})
{% if table.data_columns.size > 0 %}
DO UPDATE SET
{%- for column in table.data_columns -%}
{%- unless column.is_primary_key %}
{{ column.name }} = EXCLUDED.{{ column.name }}{% unless forloop.last %},{% endunless %}
{%- endunless -%}
{%- endfor -%};
{% else %}
DO NOTHING;
{% endif %}
{%- endfor %}
