{% for table in tables%}
INSERT INTO {{table.name}}({{ table.columns | map: "name" | join: ", " }})
VALUES (
    SELECT
    {%- for column in table.columns %}
        value->>'{{ column.name }}'{% unless forloop.last %},{% endunless %}
    {%- endfor %}
    FROM json_each(?1)
)
ON CONFLICT ({{ table.primary_key | join: ", " }})
DO UPDATE SET
{%- for column in table.columns -%}
{%- unless column.is_primary_key %}
    {{ column.name }} = EXCLUDED.{{ column.name }}
{%- endunless -%}
{%- endfor -%};
{%- endfor %}
