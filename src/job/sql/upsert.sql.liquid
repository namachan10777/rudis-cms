INSERT INTO {{ table }}({{ primary_keys | map: "name" | join: ", " }} {% if data_columns.size > 0 %},{{ data_columns | map: "name" | join: ", " }}{% endif %})
SELECT
{%- for column in primary_keys %}
    value->>'{{ column.name }}'{% unless forloop.last and data_columns.size == 0 %},{% endunless %}
{%- endfor %}
{%- for column in columns %}
    value->>'{{ column.name }}'{% unless forloop.last %},{% endunless %}
{%- endfor %}
FROM json_each(?1->>'{{ table }}')
WHERE 1
ON CONFLICT ({{ primary_keys | map: "name" | join: ", " }})
{% if data_columns > 0 %}
DO UPDATE SET
{%- for column in data_columns -%}
{{ column.name }} = EXCLUDED.{{ column.name }}{% unless forloop.last %},{% endunless %}
{%- endfor -%};
{% else %}
DO NOTHING;
{% endif %}
